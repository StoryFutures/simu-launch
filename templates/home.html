{% extends "base.html" %}

{% block content %}
  <style>
    .btn-custom {
      text-align: center !important;
      line-height: 0 !important;
      min-width: 10rem;
      min-height: 10rem;
      font-size: 5rem;
      box-sizing: content-box;
    }
  </style>



  <div class="container align-self-center">

    {% include "load/upload_modal.html" %}

    <div id="status" style="font-size: 1.5rem" class="row justify-content-center mb-2 mt-5 alert"></div>
    <div class="row justify-content-center mb-2 mt-5 btn-block" id="startButtonDiv">
      <a id="startButton" class="btn btn-success btn-custom d-flex align-items-center justify-content-center" onclick="startExperience()">START</a>

    </div>
    <div class="row justify-content-center mb-2" id="uploadButtonDiv">
      <a id="loadButton" class="btn btn-info btn-custom d-flex align-items-center justify-content-center" data-bs-toggle="modal" data-bs-target="#uploadModal">UPLOAD EXPERIENCE</a>
    </div>
    <div class="row justify-content-center mb-2" id="loadButtonDiv">
      <a id="loadButton" class="btn btn-info btn-custom d-flex align-items-center justify-content-center" onclick="loadExperience()">LOAD ON DEVICES</a>
    </div>
    <div class="row justify-content-center mb-2" id="stopButtonDiv">
      <a id="stopButton" class="btn btn-secondary btn-custom d-flex align-items-center justify-content-center" onclick="stopExperience()">STOP</a>
    </div>
    <div class="row justify-content-center mb-2" id="connectButtonDiv">
      <a id="connectButton" class="btn btn-warning btn-custom d-flex align-items-center justify-content-center" onclick="connectDevice()">CONNECT DEVICE</a>
    </div>
    <div class="row justify-content-center mb-2" id="stopServerButtonDiv">
      <a id="stopServerButton" class="btn btn-danger btn-custom d-flex align-items-center justify-content-center" onclick="stopServer()">STOP SERVER</a>
    </div>
    <div class="row justify-content-center mb-2" id="screenshotButtonDiv">
      <a id="screenshotButton" class=" btn btn-secondary btn-custom d-flex align-items-center justify-content-center" onclick="getScreenshots()">SCREENSHOT</a>
    </div>
    <div class="row justify-content-center mb-2" id="htmxGrabDiv">
      <a style="font-size: 1.5rem" class="btn btn-secondary btn-custom d-flex align-items-center justify-content-center" hx-get="/linkup" hx-swap="outerHTML" hx-trigger="click">LINKUP (polling screenshots of all devices via htmx)</a>
    </div>
  </div>


{% endblock %}

{% block javascript %}
<script>
  function uploadAPKForm() {
      const formElement = document.getElementById('uploadForm')
      var formData = new FormData(formElement)

      fetch('/upload', {
          method: 'POST',
          body: formData
      }).then(function (response) {
          if (!response.ok) {
            throw Error(response.statusText);
          }

          $('#uploadModal').modal('hide')

          return response.json();
      }).then(function (data) {
        status_global.classList.add("alert-success");
        status_global.innerHTML = "Experience has been uploaded. You may now load it on devices";
      }).catch(function (error) {
        status_global.classList.add("alert-danger");
        status_global.innerHTML = "Error uploading experience to server: " + error;
      });
  }

  status_global = document.getElementById("status");
  function remove_class(element) {
    var lastClass = element.attr('class').split(' ').pop();
    if (lastClass.includes("alert-")) {
      element.removeClass(lastClass)
    }
  }
  function startExperience() {
    document.getElementById("startButton").classList.add("disabled");
    fetch('/start', {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      }
    }).then(function (response) {
      if (!response.ok) {
        throw Error(response.statusText);
      }
      return response.json();
    }).then(function (data) {
      status_global.classList.add("alert-success");
      status_global.innerHTML = "Experience has started on " + data["device_count"] + " devices!";
      document.getElementById("startButton").classList.remove("disabled");
    }).catch(function (error) {
      status_global.classList.add("alert-danger");
      status_global.innerHTML = "Error starting experience: " + error;
      document.getElementById("startButton").classList.remove("disabled");
    });
  }

  function loadExperience() {
    document.getElementById("loadButton").classList.add("disabled");
    fetch('/load', {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      }
    }).then(function (response) {
      if (!response.ok) {
        throw Error(response.statusText);
      }
      return response.json();
    }).then(function (data) {
      status_global.classList.add("alert-success");
      status_global.innerHTML = "Experience has loaded on " + data["device_count"] + " devices!";
      document.getElementById("loadButton").classList.remove("disabled");
    }).catch(function (error) {
      status_global.classList.add("alert-danger");
      status_global.innerHTML = "Error loading experience: " + error;
      document.getElementById("loadButton").classList.remove("disabled");
    });
  }
  function stopExperience() {
    document.getElementById("stopButton").classList.add("disabled");
    fetch('/stop', {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      }
    }).then(function (response) {
      if (!response.ok) {
        throw Error(response.statusText);
      }
      return response.json();
    }).then(function (data) {
      status_global.classList.add("alert-success");
      status_global.innerHTML = "Experience has stopped on all decives!";
      document.getElementById("stopButton").classList.remove("disabled");
    }).catch(function (error) {
      status_global.classList.add("alert-danger");
      status_global.innerHTML = "Error stopping experience: " + error;
      document.getElementById("stopButton").classList.remove("disabled");
    });
  }
  function connectDevice() {
    document.getElementById("connectButton").classList.add("disabled");
    fetch('/connect', {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      }
    }).then(function (response) {
      if (!response.ok) {
        throw Error(response.error);
      }
      return response.json();
    }).then(function (data) {
      status_global.classList.add("alert-success");
      status_global.innerHTML = "Device connected with serial ID: " + data["serial"];
      document.getElementById("connectButton").classList.remove("disabled");
    }).catch(function (error) {
      status_global.classList.add("alert-danger");
      status_global.innerHTML = "Error connecting device: " + error;
      document.getElementById("connectButton").classList.remove("disabled");
    });
  }
  function stopServer() {
    document.getElementById("stopServerButton").classList.add("disabled");
    fetch('/exit-server', {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      }
    }).then(function (response) {
      if (!response.ok) {
        throw Error(response.statusText);
      }
      return response.json();
    }).then(function (data) {
      status_global.classList.add("alert-success");
      status_global.innerHTML = "ADB server has stopped!";
      document.getElementById("stopServerButton").classList.remove("disabled");
    }).catch(function (error) {
      status_global.classList.add("alert-danger");
      status_global.innerHTML = "Error stopping server: " + error;
      document.getElementById("stopServerButton").classList.remove("disabled");
    });
  }
  function getScreenshots() {
    document.getElementById("screenshotButton").classList.add("disabled");
    fetch('/screen-grab', {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      }
    }).then(function (response) {
      if (!response.ok) {
        throw Error(response.statusText);
      }
      return response.json();
    }).then(function (data) {
      status_global.classList.add("alert-success");
      status_global.innerHTML = "Screenshots have taken!";
      document.getElementById("screenshotButton").classList.remove("disabled");
    }).catch(function (error) {
      status_global.classList.add("alert-danger");
      status_global.innerHTML = "Error taking screenshots: " + error;
      document.getElementById("screenshotButton").classList.remove("disabled");
    });
  }
</script>
{% endblock %}